# memolog v0.0.11 リファクタリング計画

## 概要

v0.0.10でヘルパー関数の抽出パターンを確立したため、v0.0.11ではこれを全面的に適用し、テストカバレッジ90%超を目指す大規模リファクタリングを実施する。

## 目標

- **全体カバレッジ**: 88.4% → 90%+
- **テスト数**: 508個 → 600個+
- **アーキテクチャ**: I/O層とビジネスロジック層の完全分離

## v0.0.10での成果

### 確立されたパターン

1. **ヘルパー関数抽出パターン**
   - 純粋関数を`*-helpers.ts`に分離
   - 100%近いカバレッジを達成
   - 実装例:
     - `memo-helpers.ts` (98.78%)
     - `path-migration-helpers.ts` (100%)
     - `backup-helpers.ts` (100%)

2. **テスト追加パターン**
   - 既存機能のテストケース追加
   - エッジケースの網羅
   - 実装例:
     - `path-generator.ts`: 61.53% → 98.46%

### 残存課題

1. **memo-manager.ts** (57.79%)
   - 600行超の大規模クラス
   - I/O操作とロジックが密結合
   - さらなる分割が必要

2. **path-migrator.ts** (テスト除外)
   - ヘルパー抽出済みだが本体は未テスト
   - I/O依存の結合度が高い

3. **カバレッジ未達成ファイル**
   - cache-manager.ts: 83.09%
   - tag-manager.ts: 88%
   - performance.ts: 82.6%
   - sanitizer.ts: 90.32%

## v0.0.11 実装計画

### フェーズ1: memo-manager.ts の完全リファクタリング

#### 1.1 分析と設計 (優先度: 最高)

**目的**: memo-manager.tsの責務を明確化し、適切な粒度に分割

**作業内容**:
1. 現在のmemo-manager.ts (約600行) の責務分析
   - メモCRUD操作
   - ファイルI/O操作
   - メタデータ管理
   - タグ/カテゴリ管理
   - テンプレート処理
   - 検索機能
   - ゴミ箱管理
   - ピン留め管理

2. 以下のモジュールへの分割を検討
   ```
   memo-manager.ts          // ファサードクラス (I/O調整のみ)
   memo-crud.ts             // CRUD操作の純粋関数
   memo-metadata.ts         // メタデータ操作 (memo-helpersから移行)
   memo-file-operations.ts  // ファイル操作のラッパー
   memo-search.ts           // 検索ロジック
   memo-trash.ts            // ゴミ箱管理
   ```

3. インターフェース定義
   ```typescript
   interface MemoCRUDOperations {
     createMemo(content: string, ...): MemoEntry
     updateMemo(id: string, ...): MemoEntry
     deleteMemo(id: string): void
     getMemo(id: string): MemoEntry | null
   }

   interface MemoFileOperations {
     readMemosFromFile(path: string): MemoEntry[]
     writeMemosToFile(path: string, memos: MemoEntry[]): Promise<void>
     appendMemoToFile(path: string, memo: MemoEntry): Promise<void>
   }
   ```

**期待される成果**:
- memo-manager.ts: 600行 → 200行以下
- 新規ファイル: 4-5個
- テストカバレッジ: 57.79% → 85%+

#### 1.2 実装 (優先度: 最高)

**実装順序**:
1. `memo-crud.ts` の作成とテスト
2. `memo-metadata.ts` への移行 (memo-helpersを拡張)
3. `memo-file-operations.ts` の作成
4. `memo-search.ts` の分離
5. `memo-trash.ts` の分離
6. `memo-manager.ts` のリファクタリング

**各ステップでの作業**:
- 純粋関数の抽出
- 100個以上のテストケース追加
- 既存機能の動作確認
- カバレッジレポートの確認

### フェーズ2: path-migrator.ts のテスト追加

#### 2.1 モック化と単体テスト (優先度: 高)

**目的**: path-migrator.ts本体のテストカバレッジを確保

**作業内容**:
1. VaultHandler のモック作成
   - ファイル読み書きのモック
   - ディレクトリ操作のモック

2. PathMigrator クラスのテスト
   - `planMigration()` のテスト (20ケース)
   - `executeMigration()` のテスト (15ケース)
   - `planMemoSplitMigration()` のテスト (10ケース)
   - `executeMemoSplitMigration()` のテスト (10ケース)

3. エッジケースのカバー
   - 競合時の処理
   - エラーハンドリング
   - バックアップ処理

**期待される成果**:
- テスト追加: 55個以上
- カバレッジ: 0% → 80%+
- jest.config.js から除外リスト削除可能

#### 2.2 統合テスト (優先度: 中)

**作業内容**:
1. 実際のマイグレーションシナリオのテスト
2. 複数ファイルの一括処理テスト
3. ロールバック処理のテスト

**期待される成果**:
- 統合テスト: 10-15個
- 実用的な動作保証

### フェーズ3: カバレッジ未達成ファイルの改善

#### 3.1 cache-manager.ts (優先度: 中)

**現状**: 83.09% (目標: 95%+)

**未カバー行**: 25-33, 49-50, 95, 195-196, 206

**作業内容**:
1. 初期化処理のテスト (25-33行)
2. エラーハンドリングのテスト (49-50行)
3. キャッシュ無効化処理のテスト (95行)
4. 統計情報取得のテスト (195-196行)
5. クリーンアップ処理のテスト (206行)

**期待される成果**:
- テスト追加: 15個
- カバレッジ: 83.09% → 95%+

#### 3.2 tag-manager.ts (優先度: 中)

**現状**: 88% (目標: 95%+)

**未カバー行**: 145-160, 231-234

**作業内容**:
1. タグ統計機能のテスト (145-160行)
2. タグマージ機能のテスト (231-234行)
3. エッジケースの追加

**期待される成果**:
- テスト追加: 10個
- カバレッジ: 88% → 95%+

#### 3.3 performance.ts (優先度: 低)

**現状**: 82.6% (目標: 90%+)

**未カバー行**: 66-79

**作業内容**:
1. パフォーマンス測定の詳細テスト
2. メトリクス収集のテスト

**期待される成果**:
- テスト追加: 8個
- カバレッジ: 82.6% → 90%+

#### 3.4 sanitizer.ts (優先度: 低)

**現状**: 90.32% (目標: 95%+)

**未カバー行**: 32, 42, 47, 61, 89, 109

**作業内容**:
1. 特殊文字処理のエッジケース
2. XSS対策の境界値テスト
3. パス正規化の複雑なケース

**期待される成果**:
- テスト追加: 12個
- カバレッジ: 90.32% → 95%+

### フェーズ4: アーキテクチャドキュメント整備

#### 4.1 設計文書の作成 (優先度: 中)

**作成するドキュメント**:
1. `ARCHITECTURE.md`: 全体アーキテクチャ
2. `TESTING_GUIDE.md`: テスト方針とベストプラクティス
3. 各モジュールのREADME

**内容**:
- 責務分離の原則
- I/O層とビジネスロジック層の分離方針
- ヘルパー関数抽出のガイドライン
- モックとスタブの使い分け
- カバレッジ目標値の設定

#### 4.2 コード規約の明文化 (優先度: 低)

**作成内容**:
- TypeScript コーディング規約
- テスト命名規則
- ファイル構成ルール
- コメント記述ガイドライン

## 実装スケジュール

### 週1: フェーズ1.1 (分析と設計)
- Day 1-2: memo-manager.ts の責務分析
- Day 3-4: インターフェース設計
- Day 5-7: 分割計画の詳細化

### 週2-3: フェーズ1.2 (実装)
- Week 2: memo-crud.ts, memo-metadata.ts
- Week 3: memo-file-operations.ts, memo-search.ts, memo-trash.ts

### 週4: フェーズ2 (path-migrator.ts)
- Day 1-3: モック化と単体テスト
- Day 4-7: 統合テスト

### 週5: フェーズ3 (カバレッジ改善)
- Day 1-2: cache-manager.ts, tag-manager.ts
- Day 3-4: performance.ts, sanitizer.ts
- Day 5-7: 統合テストとバグフィックス

### 週6: フェーズ4 (ドキュメント)
- Day 1-5: ARCHITECTURE.md, TESTING_GUIDE.md
- Day 6-7: 最終レビューとリリース準備

## 成果目標

### 数値目標
- **テストカバレッジ**: 88.4% → 90%+
- **テスト数**: 508個 → 650個+
- **コード行数**: 最適化により10-15%削減
- **平均関数サイズ**: 30行以下

### 品質目標
- すべての公開APIに対するテスト
- エッジケースの網羅
- I/O層とビジネスロジック層の完全分離
- モジュール間の疎結合化

### ドキュメント目標
- アーキテクチャ文書の完成
- テストガイドの整備
- 各モジュールのAPI仕様明確化

## リスクと対策

### リスク1: 大規模変更による既存機能の破壊

**対策**:
- 各フェーズ後に全テスト実行
- 段階的なリファクタリング
- 既存テストの継続的な実行

### リスク2: テストコードの肥大化

**対策**:
- テストユーティリティの共通化
- データ駆動テストの活用
- 適切なテストスコープの設定

### リスク3: スケジュール遅延

**対策**:
- 優先度に基づく実装
- 週次の進捗確認
- 最小限の成果物でのリリース判断

## 完了条件

以下の全条件を満たした時点でv0.0.11完了とする:

1. ✅ 全体テストカバレッジが90%以上
2. ✅ 全テストがパス (508個 → 650個+)
3. ✅ memo-manager.ts が200行以下に削減
4. ✅ path-migrator.ts がテスト除外リストから削除
5. ✅ 既存機能の動作確認完了
6. ✅ ARCHITECTURE.md の作成完了
7. ✅ ビルドとCI/CDが正常動作

## 次バージョン (v0.0.12) への引継ぎ

v0.0.11で未達成の場合:
- UI層のテスト追加 (現在除外)
- パフォーマンス最適化
- 新機能追加の準備

---

**作成日**: 2025-10-30
**対象バージョン**: v0.0.11
**前バージョン**: v0.0.10 (カバレッジ88.4%, 508テスト)
