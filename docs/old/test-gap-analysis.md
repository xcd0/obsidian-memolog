# テストギャップ分析

## 概要

現状のテストコードとテスト方針書とのギャップを分析し、改善すべき点を明らかにする。

## 現状のテストの良い点

### 1. バグ検証テストの存在

- `date-range-filter-bug.test.ts`: 実際のバグを再現するテストが存在する。
- `week-filter-duplicate-bug.test.ts`: 一週間フィルターの重複バグを検証している。
- これらは「バグ修正時は再現テストを追加する」というTDD原則に合致している。

### 2. 境界値テストの実施

- `date-range-filter.test.ts`: 月末、年末、閏年などの境界値をテストしている。
- タイムゾーンの境界値もテストしている。

### 3. タイムゾーン処理のテスト

- `timezone-handling.test.ts`: タイムゾーン関連の処理を専用のテストファイルで管理している。
- UTC時刻とローカル時刻の扱いを明確に区別している。

### 4. モックの適切な使用

- `memo-manager.test.ts`: VaultHandlerをモック化し、ファイルI/Oを抽象化している。
- `settings.test.ts`: Obsidian APIをモック化している。

### 5. コメントの充実

- テストの意図がコメントで明確に記載されている。
- 日本語コメントにより、テストの背景が分かりやすい。

## 現状のテストの問題点

### 1. AAA(Arrange-Act-Assert)パターンの不明確さ

**問題**:
多くのテストでArrange、Act、Assertのセクションが明確に分離されていない。

**例**: `date-range-filter.test.ts` 164-214行目

```typescript
it("「今日」フィルターは今日のタイムスタンプを持つメモのみを返す", () => {
	//! テスト用のメモデータを作成。 <- Arrange
	const now = new Date();
	const yesterday = new Date(now);
	// ... (多数の準備処理)

	const memos: MemoEntry[] = [ ... ]; <- Arrange

	//! 「今日」フィルターのロジックを再現。 <- Arrange続き
	const startDate = new Date();
	// ...

	//! タイムスタンプベースのフィルタリング。 <- Act
	const filtered = memos.filter((memo) => { ... });

	//! 今日のメモのみが含まれることを確認。 <- Assert
	expect(filtered).toHaveLength(2);
	// ...
});
```

**改善案**:
空行やコメントでセクションを明確に分離する。

### 2. 1つのテストで複数のことをテストしている

**問題**:
1つのテストケース内で複数の検証を行っている。

**例**: `date-range-filter-bug.test.ts` 229-284行目
このテストでは以下の複数のことを検証している:

- フィルタリング後のメモ数
- 過去のメモが除外されること
- 正しいメモが含まれること
- メモのコンテンツが正しいこと

**改善案**:
1つのテストでは1つの振る舞いのみを検証する。複数の検証が必要な場合は、テストを分割する。

### 3. テスト名が実装詳細に依存している

**問題**:
一部のテストでは「どう振る舞うか」ではなく「どう実装されているか」に焦点が当たっている。

**例**: `date-range-filter.test.ts` 76-91行目

```typescript
it("toISOString().split('T')[0]はUTC日付を返す", () => { ... });
```

これは実装の詳細(toISOStringの使用)に依存している。

**改善案**:
「日付文字列がUTC基準で生成される」など、振る舞いに焦点を当てたテスト名にする。

### 4. マジックナンバーの使用

**問題**:
テストコード内にマジックナンバーが散在している。

**例**: `date-range-filter.test.ts` 48-49行目

```typescript
const daysDiff = Math.floor((today.getTime() - weekAgo.getTime()) / (1000 * 60 * 60 * 24))
expect(daysDiff).toBe(7)
```

`1000 * 60 * 60 * 24` は「1日のミリ秒数」だが、定数化されていない。

**改善案**:

```typescript
const MILLISECONDS_PER_DAY = 1000 * 60 * 60 * 24
const daysDiff = Math.floor((today.getTime() - weekAgo.getTime()) / MILLISECONDS_PER_DAY)
const EXPECTED_WEEK_DAYS = 7
expect(daysDiff).toBe(EXPECTED_WEEK_DAYS)
```

### 5. テストデータの重複

**問題**:
複数のテストで似たようなテストデータを生成している。

**例**: `date-range-filter.test.ts` と `date-range-filter-bug.test.ts` で同じようなメモデータ構造を作成している。

**改善案**:
テストデータ生成のヘルパー関数を作成する。

```typescript
function createTestMemo(id: string, timestamp: string, content: string): MemoEntry {
	return { id, timestamp, content, category: "test" }
}
```

### 6. コンソールログの残存

**問題**:
本番テストコードにconsole.logが残っている。

**例**: `week-filter-duplicate-bug.test.ts` 115-160行目

```typescript
console.log("=== 複数ファイルから読み込み ===")
console.log("ファイル2のメモ数:", memosFile2.length)
```

**改善案**:
デバッグ用のログは削除するか、環境変数で制御する。

### 7. テストのタイトルが長すぎる

**問題**:
一部のテストタイトルが非常に長く、読みにくい。

**例**:

```typescript
it("【バグ検証】修正前: ファイル内の全メモが読み込まれていた（不具合の再現確認）", async () => { ... });
```

**改善案**:
テストタイトルは簡潔にし、詳細はテスト内のコメントで補足する。

```typescript
it("修正前: 日付フィルターが機能しない", async () => {
	// ! バグの状況: ファイル内の全メモが読み込まれていた。
	// ...
})
```

### 8. Red-Green-Refactorサイクルの不明確さ

**問題**:
バグ修正テストは存在するが、「修正前(Red)」と「修正後(Green)」のテストが同じファイル内に混在している。

**例**: `date-range-filter-bug.test.ts` には「修正前」と「修正後」の両方のテストがある。

**改善案**:

- 修正前のテスト(Red)は、修正前にコミットする。
- 修正後は、そのテストが通ること(Green)を確認する。
- 修正前のテストを「修正前」「修正後」で分けるのではなく、1つのテストが「最初は失敗→修正後は成功」となるようにする。

### 9. モックの過剰使用

**問題**:
一部のテストでモックが過剰に使用され、実際の動作との乖離がある可能性。

**例**: `memo-manager.test.ts` では、VaultHandlerを完全にモック化している。

**改善案**:

- 単体テストではモックを使用する。
- 統合テストでは実際のオブジェクトを使用する(または、より現実に近いモック)。
- テストの種類(単体/統合)を明確にする。

### 10. テストの独立性の問題

**問題**:
一部のテストで、前のテストの結果に依存している可能性がある。

**例**: `week-filter-duplicate-bug.test.ts` では、beforeEachでモックをセットアップしているが、テスト間で状態が共有される可能性がある。

**改善案**:

- beforeEachで確実に状態をクリアする。
- afterEachで必要なクリーンアップを行う。
- テストの実行順序に依存しないことを確認する。

## 優先度別改善項目

### 高優先度(すぐに対応すべき)

1. AAA(Arrange-Act-Assert)パターンの明確化。
2. 1つのテストで1つのことだけをテストする。
3. コンソールログの削除。
4. マジックナンバーの定数化。

### 中優先度(次のフェーズで対応)

5. テストデータ生成のヘルパー関数化。
6. テストタイトルの簡潔化。
7. テスト名を振る舞いベースに変更。

### 低優先度(時間があれば対応)

8. テストの独立性の確認と改善。
9. モックの使用方針の見直し。
10. Red-Green-Refactorサイクルの可視化。

## 改善の方向性

### フェーズ1: 既存テストの品質向上

- 現状のテストファイルはそのまま残す。
- 新規に「改善版テスト」を作成する。
- ファイル名に `-improved` サフィックスを付ける。
- 例: `date-range-filter-improved.test.ts`

### フェーズ2: ベストプラクティスの確立

- 改善版テストから得られた知見をドキュメント化する。
- テストテンプレートを作成する。
- 今後の新規テストは、このテンプレートに従う。

### フェーズ3: 既存テストの段階的移行

- 改善版テストが安定したら、既存テストを徐々に置き換える。
- CI/CDパイプラインで両方のテストを実行し、結果を比較する。

## まとめ

現状のテストは基本的な品質は確保されているが、以下の点で改善の余地がある:

1. **構造**: AAAパターンの明確化が必要。
2. **焦点**: 1つのテストで1つのことだけをテストする。
3. **可読性**: マジックナンバーの削除、テスト名の改善。
4. **保守性**: テストデータの共通化、ヘルパー関数の活用。
5. **TDD原則**: Red-Green-Refactorサイクルの可視化。

これらの改善を段階的に進めることで、テストの品質を向上させ、保守性の高いテストコードを実現する。
